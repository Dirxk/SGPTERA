@{
    ViewData["Title"] = "ClientesUsuarios";
    var IdUsuario = ViewBag.IdUsuario;

}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@500&display=swap" rel="stylesheet">

<!-- ================================================================================================= -->
<!-- ======================================== Codigo Principal ======================================= -->
<!-- ================================================================================================= -->
<div class="card d-flex flex-column">
    <div class="card-header d-flex flex-column flex-md-row align-items-center justify-content-center justify-content-md-between">
        <!-- Primera columna: Título -->
        <div class="col-12 col-md-6 d-flex align-items-center justify-content-center justify-content-md-start mb-3 mb-md-0">
            <i class="fa-solid fa-users fa-lg me-2 d-none d-md-block"></i>
            <i class="fa-solid fa-users me-2 mb-2 d-block d-md-none"></i>
            <h3 class="m-0 d-none d-md-block" style="font-family: 'Rubik', sans-serif; font-size: 1.25rem;">Clientes Usuarios</h3>
            <h6 class="m-0 d-block d-md-none mb-1" style="font-family: 'Rubik', sans-serif; font-size: 1rem;">Clientes Usuarios</h6>
        </div>

        <!-- Segunda columna: Búsqueda y botones -->
        <div class="col-12 col-md-6 d-flex justify-content-center justify-content-md-end gap-2 mt-2 mt-md-0">
            <!-- Input de búsqueda -->
            <input id="inputBusqueda" class="form-control form-control-sm w-50" type="search" placeholder="Buscar" aria-label="Search">
            <!-- Botón de búsqueda -->
            <button id="btnBuscar" class="btn btn-info btn-sm" type="submit">
                <i class="fas fa-search"></i>
            </button>
            <!-- Botón de recargar -->
            <button type="button" id="btnReloadClientesUsuarios" name="btnReloadClientesUsuarios" class="btn btn-warning btn-sm">
                <i class="fas fa-sync-alt"></i>
            </button>
            <!-- Botón de agregar cliente usuario -->
            <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#UserModal">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>
    <div class="card-body p-3 flex-grow-1">
        <div class="table-responsive scrollbar h-100">
            <!-- Grilla de clientes usuarios -->
            <div id="GridClientesUsuarios" style="width: 100%; height: calc(75vh - 50px);"></div>
            <!-- Mensaje de "Cliente usuario no encontrado" -->
            <div id="mensajeNoEncontrado" class="text-danger mt-2" style="display: none;">Cliente usuario no encontrado</div>
        </div>
    </div>
</div>

<!-- ================================================================================================= -->
<!-- ======================================= Modal nuevo cliente ===================================== -->
<!-- ================================================================================================= -->

<div class="modal fade" id="UserModal" tabindex="-1" aria-labelledby="UserModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-md">
        <div class="modal-content">
            <form id="FormCrearUsuario">
                <div class="modal-header">
                    <h3 class="modal-title" id="UserModalLabel">Agregar nuevo Usuario del Cliente</h3>
                    <button type="button" class="btn-close cerrarModal" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Campo: Cliente Usuario -->
                        <div class="col-12 col-md-4 mb-3">
                            <div class="form-floating">
                                <input class="form-control" id="InpClienteUsuario" name="InpClienteUsuario" type="text" placeholder="Cliente Usuario" required autocomplete="off" />
                                <label for="InpClienteUsuario">Cliente Usuario <span class="text-danger">*</span></label>
                            </div>
                        </div>
                        <!-- Campo: Nombre Cliente Usuario -->
                        <div class="col-12 col-md-4 mb-3">
                            <div class="form-floating">
                                <input class="form-control" id="InpNombreClienteUsuario" name="InpNombreClienteUsuario" type="text" placeholder="Nombre Cliente Usuario" required autocomplete="off" />
                                <label for="InpNombreClienteUsuario">Nombre(s) <span class="text-danger">*</span></label>
                            </div>
                        </div>
                        <!-- Campo: Apellido Paterno Cliente Usuario -->
                        <div class="col-12 col-md-4 mb-3">
                            <div class="form-floating">
                                <input class="form-control" id="InpApellidoPaternoClienteUsuario" name="InpApellidoPaternoClienteUsuario" type="text" placeholder="Apellido Paterno Cliente Usuario" required autocomplete="off" />
                                <label for="InpApellidoPaternoClienteUsuario">Apellido paterno <span class="text-danger">*</span></label>
                            </div>
                        </div>
                        <!-- Campo: Apellido Materno Cliente Usuario -->
                        <div class="col-12 col-md-4 mt-3">
                            <div class="form-floating">
                                <input class="form-control" id="InpApellidoMaternoClienteUsuario" name="InpApellidoMaternoClienteUsuario" type="text" placeholder="Apellido Materno Cliente Usuario" required autocomplete="off" />
                                <label for="InpApellidoMaternoClienteUsuario">Apellido materno <span class="text-danger">*</span></label>
                            </div>
                        </div>
                        <!-- Campo: IdCliente -->
                        <div class="col-12 col-md-4 mb-3">
                            <div class="form-group">
                                <label for="cbIdEmpresa" class="form-label">EMPRESA: <span class="text-danger">*</span></label>
                                <div id="cbIdEmpresa"></div>
                            </div>
                        </div>
                        <!-- Campo: IdPuesto -->
                        <div class="col-12 col-md-4 mb-3">
                            <div class="form-group">
                                <label for="cbIdPuesto" class="form-label">PUESTO: <span class="text-danger">*</span></label>
                                <div id="cbIdPuesto"></div>
                            </div>
                        </div>
                        <!-- Campo: Correo -->
                        <div class="col-12 mb-3 mt-2">
                            <div class="form-floating">
                                <input class="form-control" id="InpCorreo" name="InpCorreo" type="email" placeholder="Correo" required autocomplete="off" />
                                <label for="InpCorreo">Correo <span class="text-danger">*</span></label>
                            </div>
                        </div>
                        <!-- Campo: Teléfono -->
                        <div class="col-12 col-md-4 mb-3">
                            <div class="form-floating">
                                <input class="form-control" id="InpTelefono" name="InpTelefono" type="text" placeholder="Teléfono" maxlength="15" required autocomplete="off" />
                                <label for="InpTelefono">Teléfono <span class="text-danger">*</span></label>
                            </div>
                        </div>
                        <!-- Campo: Contraseña -->
                        <div class="col-12 col-md-4 mb-3">
                            <div class="form-floating">
                                <input class="form-control" id="InpContrasena" name="InpContrasena" type="password" placeholder="Contraseña" required autocomplete="off" />
                                <label for="InpContrasena">Contraseña <span class="text-danger">*</span></label>
                            </div>
                        </div>
                        <!-- Campo: Repetir Contraseña -->
                        <div class="col-12 col-md-4 mb-3">
                            <div class="form-floating">
                                <input class="form-control" id="InpRepetirContrasena" name="InpRepetirContrasena" type="password" placeholder="Repetir Contraseña" required autocomplete="off" />
                                <label for="InpRepetirContrasena">Repite la contraseña <span class="text-danger">*</span></label>
                            </div>
                        </div>
                        <!-- Campo: Imagen -->
                        <div class="col-12 mb-3">
                            <label class="fw-bold mb-2" style="font-size: 1rem;">Imagen para el usuario:</label>
                            <input class="form-control" id="InpImagenExt" name="InpImagenExt" type="file" accept="image/*" />
                        </div>
                        <!-- Previsualización de la imagen -->
                        <div class="col-12 mb-3">
                            <div id="previewContainer" class="d-none border rounded p-1 d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <img id="previewImage" src="" alt="Previsualización" class="img-thumbnail me-2" style="max-width: 60px; max-height: 60px; object-fit: contain;">
                                    <div>
                                        <p id="fileName" class="mb-0 fw-bold"></p>
                                        <small id="fileSize" class="text-muted"></small>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-link text-danger p-2" id="removePreview" aria-label="Eliminar previsualización">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Contenedor para alertas -->
                        <div class="col-12">
                            <div class="ContAlerta"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger cerrarModal" data-bs-dismiss="modal">
                        <i class="fas fa-ban me-2"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-success px-5" id="BtnAgregarUsuarioExt">
                        <i class="fas fa-user-plus me-2"></i>Agregar usuario
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ================================================================================================= -->
<!-- ====================================== Modal editar cliente usuario ============================= -->
<!-- ================================================================================================= -->

<div class="modal fade" id="ModalEditarClienteUsuario" tabindex="-1" aria-labelledby="ModalEditarClienteUsuarioLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-md">
        <div class="modal-content">
            <form id="FormEditarClienteUsuario">
                <div class="modal-header">
                    <h5 class="modal-title" id="ModalEditarClienteUsuarioLabel">Editar Usuario del Cliente</h5>
                    <button type="button" class="btn-close cerrarModalEditarClienteUsuario" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Campo: Cliente Usuario -->
                        <div class="col-12 col-md-4 mb-3">
                            <div class="form-floating">
                                <input class="form-control" id="InpClienteUsuarioEdit" name="InpClienteUsuarioEdit" type="text" placeholder="Cliente Usuario" required autocomplete="off" />
                                <label for="InpClienteUsuarioEdit">Cliente Usuario</label>
                            </div>
                        </div>
                        <!-- Campo: Nombre Cliente Usuario -->
                        <div class="col-12 col-md-4 mb-3">
                            <div class="form-floating">
                                <input class="form-control" id="InpNombreClienteUsuarioEdit" name="InpNombreClienteUsuarioEdit" type="text" placeholder="Nombre Cliente Usuario" required autocomplete="off" />
                                <label for="InpNombreClienteUsuarioEdit">Nombre(s)</label>
                            </div>
                        </div>
                        <!-- Campo: Apellido Paterno Cliente Usuario -->
                        <div class="col-12 col-md-4 mb-3">
                            <div class="form-floating">
                                <input class="form-control" id="InpApellidoPaternoClienteUsuarioEdit" name="InpApellidoPaternoClienteUsuarioEdit" type="text" placeholder="Apellido Paterno Cliente Usuario" required autocomplete="off" />
                                <label for="InpApellidoPaternoClienteUsuarioEdit">Apellido paterno</label>
                            </div>
                        </div>
                        <!-- Campo: Apellido Materno Cliente Usuario -->
                        <div class="col-12 col-md-4 mb-3">
                            <div class="form-floating">
                                <input class="form-control" id="InpApellidoMaternoClienteUsuarioEdit" name="InpApellidoMaternoClienteUsuarioEdit" type="text" placeholder="Apellido Materno Cliente Usuario" required autocomplete="off" />
                                <label for="InpApellidoMaternoClienteUsuarioEdit">Apellido materno</label>
                            </div>
                        </div>
                        <!-- Campo: IdCliente -->
                        <div class="col-12 col-md-4 mb-3">
                            <div class="form-group">
                                <label for="cbIdEmpresaEdit" class="form-label">EMPRESA:</label>
                                <div id="cbIdEmpresaEdit"></div>
                            </div>
                        </div>
                        <!-- Campo: IdPuesto -->
                        <div class="col-12 col-md-4 mb-3">
                            <div class="form-group">
                                <label for="cbIdPuestoEdit" class="form-label">PUESTO:</label>
                                <div id="cbIdPuestoEdit"></div>
                            </div>
                        </div>
                        <!-- Campo: Correo -->
                        <div class="col-12 col-md-4 mb-3">
                            <div class="form-floating">
                                <input class="form-control" id="InpCorreoEdit" name="InpCorreoEdit" type="email" placeholder="Correo" required autocomplete="off" />
                                <label for="InpCorreoEdit">Correo</label>
                            </div>
                        </div>
                        <!-- Campo: Teléfono -->
                        <div class="col-12 col-md-4 mb-3">
                            <div class="form-floating">
                                <input class="form-control" id="InpTelefonoEdit" name="InpTelefonoEdit" type="text" placeholder="Teléfono" maxlength="15" required autocomplete="off" />
                                <label for="InpTelefonoEdit">Teléfono</label>
                            </div>
                        </div>
                        <!-- Campo: Contraseña -->
                        <div class="col-12 col-md-4 mb-3">
                            <div class="form-floating">
                                <input class="form-control" id="InpContrasenaEdit" name="InpContrasenaEdit" type="password" placeholder="Contraseña" maxlength="15" required autocomplete="off" />
                                <label for="InpContrasenaEdit">Nueva Contraseña</label>
                            </div>
                        </div>
                        <!-- Campo: Imagen -->
                        <div class="col-sm-12 mt-4">
                            <label class="fw-bold mb-2" style="font-size: 1rem;">Logotipo del cliente usuario:</label>
                            <input class="form-control" id="InpClienteUsuarioImagenEdit" name="imagen" type="file" accept="image/*" />
                        </div>
                        <div class="col-12 mt-3">
                            <div id="previewContainerEdit" class="border rounded p-1 d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <img id="previewImageEdit" src="" alt="Previsualización" class="img-thumbnail me-3 previewImage" style="max-width: 100px; max-height: 100px; object-fit: contain;">
                                    <div>
                                        <p id="fileNameEdit" class="mb-0 fw-bold"></p>
                                        <small id="fileSizeEdit" class="text-muted"></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="ContAlertaEdit" class="col-12"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger cerrarModalEditarClienteUsuario">Cancelar</button>
                    <button type="button" class="btn btn-success EditarClienteUsuario" id="btnActualizarClienteUsuario">Actualizar Cliente Usuario</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ================================================================================================= -->
<!-- ====================================== Modal eliminar cliente usuario =========================== -->
<!-- ================================================================================================= -->
<div class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" id="ModalEliminarClienteUsuario" tabindex="-1" aria-labelledby="verticallyCenteredModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="FormEliminarClienteUsuario">
                <div class="modal-header">
                    <h5 class="modal-title" id="verticallyCenteredModalLabel">Eliminar Usuario del Cliente</h5>
                    <button class="btn p-1" type="button" data-bs-dismiss="modal" aria-label="Close">
                        <span class="fas fa-times fs--1"></span>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="text-700 lh-lg mb-0">
                        ¿Deseas eliminar el cliente usuario <strong class="nombreClienteUsuario"></strong>?
                    </p>
                </div>
                <div class="modal-footer">
                    <div class="col-auto">
                        <button class="btn btn-primary me-1 mb-1" type="button" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-danger me-1 mb-1" type="submit" id="BtnEliminarClienteUsuario">Eliminar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ================================================================================================= -->
<!-- ====================================== Modal reactivar cliente usuario ========================== -->
<!-- ================================================================================================= -->

<div class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" id="ModalConfirmarClienteUsuario" tabindex="-1" aria-labelledby="verticallyCenteredModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="FormConfirmarClienteUsuario">
                <div class="modal-header">
                    <h5 class="modal-title" id="verticallyCenteredModalLabel">Reactivar Usuario del Cliente</h5>
                    <button class="btn p-1" type="button" data-bs-dismiss="modal" aria-label="Close">
                        <span class="fas fa-times fs--1"></span>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="text-700 lh-lg mb-0">
                        ¿Deseas reactivar el cliente usuario <strong class="nombreConfirmarClienteUsuario"></strong>?
                    </p>
                </div>
                <div class="modal-footer">
                    <div class="col-auto">
                        <button class="btn btn-primary me-1 mb-1" type="button" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-success me-1 mb-1" type="submit" id="BtnConfirmarClienteUsuario">Reactivar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>


@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>

        //============================================================================================================================\\
        //====================================================  Variables Globales  ===================================================\\
        //==============================================================================================================================\\
        // Variable global para almacenar la instancia de la grilla de clientes usuarios.
        var gridClientesUsuarios = null;

        // Inicializar el AutoComplete con los datos obtenidos

        var cbIdEmpresa = new wijmo.input.AutoComplete('#cbIdEmpresa', {
            displayMemberPath: 'Empresa', selectedValuePath: 'Id', itemsSource: [],  selectedValue: -1
        });

        var cbIdPuesto = new wijmo.input.AutoComplete('#cbIdPuesto', {
            displayMemberPath: 'Puesto', selectedValuePath: 'Id', itemsSource: [], selectedValue: -1
        });

        var cbIdEmpresaEdit = new wijmo.input.AutoComplete('#cbIdEmpresaEdit', {
            displayMemberPath: 'Empresa', selectedValuePath: 'Id', itemsSource: []
        });

        var cbIdPuestoEdit = new wijmo.input.AutoComplete('#cbIdPuestoEdit', {
            displayMemberPath: 'Puesto', selectedValuePath: 'Id', itemsSource: [], selectedValue: -1
        });


        // Función que realiza una solicitud AJAX para obtener los clientes usuarios desde el servidor.
        function verClientesUsuarios() {
            return new Promise((resolve, reject) => {
                const startTime = performance.now(); // Inicia el contador para medir el tiempo de respuesta.

                $.ajax({
                    type: 'POST', // Método HTTP utilizado para la solicitud.
                    data: {}, // Datos enviados al servidor (en este caso, vacío).
                    url: '@Url.Action("GetClientesUsuarios", "Catalogos")', // URL de la acción para obtener clientes usuarios.
                    success: function (datos) {
                        const endTime = performance.now(); // Finaliza el contador de tiempo.
                        const serverResponseTime = endTime - startTime; // Calcula el tiempo de respuesta del servidor.
                        gridClientesUsuarios.itemsSource = datos.data; // Asigna los datos recibidos a la grilla de clientes usuarios.
                        resolve(serverResponseTime); // Resuelve la promesa con el tiempo de respuesta.
                    },
                    error: function () {
                        console.error("Error al obtener los clientes usuarios."); // Maneja errores en la solicitud.
                        reject(); // Rechaza la promesa en caso de error.
                    }
                });
            });
        }

        //============================================================================================================================\\
        //================================== funciones para obtener los datos de empresa y de puestos =================================\\
        //==============================================================================================================================\\

        function getDataEmpresa() {
            return new Promise((resolve, reject) => {
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("GetClientes", "Catalogos")',
                    success: function (response) {
                        if (response.resultado && response.data && response.data.length > 0) {
                            // Filtrar solo los clientes activos y mapear al formato requerido
                            const data = response.data
                                .filter(cliente => cliente.flgActivo == 1)
                                .map(cliente => ({
                                    Id: cliente.id,
                                    Empresa: cliente.razonSocial
                                }));
                            resolve(data); // Resolver la promesa con los datos
                        } else {
                            reject("No se pudieron obtener los clientes o la respuesta está vacía.");
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        reject("Error al obtener los clientes: " + textStatus + " - " + errorThrown);
                    }
                });
            });
        }

        function getDataPuesto() {
            return new Promise((resolve, reject) => {
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("GetPuestos", "Catalogos")',
                    success: function (response) {
                        if (response.resultado && response.data && response.data.length > 0) {
                            // Filtrar solo los puestos activos y del tipo 2, y mapear al formato requerido
                            const data = response.data
                                .filter(puesto => puesto.flgActivo == 1 && puesto.tipo == 2)
                                .map(puesto => ({
                                    Id: puesto.id,
                                    Puesto: puesto.descripcion
                                }));
                            resolve(data); // Resolver la promesa con los datos
                        } else {
                            reject("No se pudieron obtener los puestos o la respuesta está vacía.");
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        reject("Error al obtener los puestos: " + textStatus + " - " + errorThrown);
                    }
                });
            });
        }

        //============================================================================================================================\\
        //================================  Función para editar un cliente usuario específico basado en su ID  =========================\\
        //==============================================================================================================================\\

        function EditarClienteUsuario(id) {
            const clienteusuario = gridClientesUsuarios.itemsSource.find(u => u.id === id);
            if (clienteusuario) {
                // Guardar los valores iniciales del cliente usuario
                valoresIniciales = {
                    clienteusuario: clienteusuario.clienteUsuario || '',
                    nombreClienteUsuario: clienteusuario.nombreClienteUsuario || '',
                    apellidoPaternoClienteUsuario: clienteusuario.apellidoPaternoClienteUsuario || '',
                    apellidoMaternoClienteUsuario: clienteusuario.apellidoMaternoClienteUsuario || '',
                    telefono: clienteusuario.telefono || '',
                    correo: clienteusuario.correo || '',
                    fotoPerfil: clienteusuario.fotoPerfil || '',
                    idCliente: clienteusuario.idCliente || -1,
                    idPuesto: clienteusuario.idPuesto || -1 // Agrega IdPuesto aquí
                };

                // Asigna los valores del cliente usuario a los campos del formulario de edición.
                $('#InpClienteUsuarioEdit').val(valoresIniciales.clienteusuario);
                $('#InpNombreClienteUsuarioEdit').val(valoresIniciales.nombreClienteUsuario);
                $('#InpApellidoPaternoClienteUsuarioEdit').val(valoresIniciales.apellidoPaternoClienteUsuario);
                $('#InpApellidoMaternoClienteUsuarioEdit').val(valoresIniciales.apellidoMaternoClienteUsuario);
                $('#InpTelefonoEdit').val(valoresIniciales.telefono);
                $('#InpCorreoEdit').val(valoresIniciales.correo);

                // Muestra la imagen del cliente usuario si está disponible.
                if (clienteusuario.fotoPerfil && typeof clienteusuario.fotoPerfil === 'string') {
                    $('#previewImageEdit').attr('src', `data:image/png;base64,${clienteusuario.fotoPerfil}`);
                    $('#previewContainerEdit').css('display', 'flex');
                } else {
                    const rutaImagenPorDefecto = "/lib/dashboard/assets/img/IMAGE.svg";
                    $('#previewImageEdit').attr('src', rutaImagenPorDefecto);
                    $('#previewContainerEdit').css('display', 'flex');
                }

                // Deshabilitar el botón de actualizar inicialmente
                $('#btnActualizarClienteUsuario').prop('disabled', true);

                // Muestra el modal de edición de cliente usuario.
                const modalEditarClienteUsuario = new bootstrap.Modal($('#ModalEditarClienteUsuario')[0]);
                modalEditarClienteUsuario.show();
                $('#btnActualizarClienteUsuario').data('id', id);

                // Cargar datos de empresas
                getDataEmpresa()
                    .then(data => {
                        cbIdEmpresaEdit.itemsSource = data;
                        const idCliente = Number(valoresIniciales.idCliente);
                        const empresaSeleccionada = data.find(empresa => empresa.Id === idCliente);
                        if (empresaSeleccionada) {
                            cbIdEmpresaEdit.selectedValue = idCliente;
                        } else {
                            const valorPorDefecto = data[0]?.Id || null;
                            cbIdEmpresaEdit.selectedValue = valorPorDefecto;
                            console.warn("idCliente no encontrado. Usando valor por defecto:", valorPorDefecto);
                        }
                    })
                    .catch(error => {
                        console.error(error);
                        swal.fire('Error', 'No se pudieron cargar los datos de las empresas disponibles.', 'error');
                        cbIdEmpresaEdit.isDisabled = true;
                    });

                // Cargar datos de puestos
                getDataPuesto()
                    .then(data => {
                        cbIdPuestoEdit.itemsSource = data;
                        const idPuesto = Number(valoresIniciales.idPuesto);
                        const puestoSeleccionado = data.find(puesto => puesto.Id === idPuesto);
                        if (puestoSeleccionado) {
                            cbIdPuestoEdit.selectedValue = idPuesto;
                        } else {
                            const valorPorDefecto = data[0]?.Id || null;
                            cbIdPuestoEdit.selectedValue = valorPorDefecto;
                            console.warn("IdPuesto no encontrado. Usando valor por defecto:", valorPorDefecto);
                        }
                    })
                    .catch(error => {
                        console.error(error);
                        swal.fire('Error', 'No se pudieron cargar los datos de los puestos disponibles.', 'error');
                        cbIdPuestoEdit.isDisabled = true;
                    });
            } else {
                console.error("Cliente usuario no encontrado.");
            }
        }

        //============================================================================================================================\\
        //===============================  Inicialización del GRID Clientes Usuarios y Configuración de Eventos  ======================\\
        //==============================================================================================================================\\

        $(document).ready(function () {

            //============================================================================================================================\\
            //================================================  Validaciones de los Inputs  ===============================================\\
            //==============================================================================================================================\\

            $("#InpClienteUsuario, #InpClienteUsuarioEdit").on("input", function () {
                // Elimina caracteres no permitidos y evita dos puntos juntos
                $(this).val(
                    $(this).val()
                        .replace(/[^a-zA-Z0-9.]/g, "") // Solo permite letras, números y puntos
                        .replace(/\.{2,}/g, ".") // Evita dos o más puntos juntos
                );
            });

            $("#InpNombreClienteUsuario, #InpNombreClienteUsuarioEdit").on("input", function () {
                $(this).val($(this).val().replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ ]/g, "")); // Permite letras y espacios
            });

            $("#InpApellidoPaternoClienteUsuario, #InpApellidoPaternoClienteUsuarioEdit").on("input", function () {
                $(this).val($(this).val().replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ ]/g, "")); // Permite letras y espacios
            });

            $("#InpApellidoMaternoClienteUsuario, #InpApellidoMaternoClienteUsuarioEdit").on("input", function () {
                $(this).val($(this).val().replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ ]/g, "")); // Permite letras y espacios
            });

            //============================================================================================================================\\
            //==========================================               GRID Principal                ======================================\\
            //==============================================================================================================================\\
            gridClientesUsuarios = new wijmo.grid.FlexGrid('#GridClientesUsuarios', {
                autoGenerateColumns: false,
                headersVisibility: 'Column',
                itemsSource: [],
                selectionMode: wijmo.grid.SelectionMode.Row,
                columns: [
                    { binding: '', header: '#', width: 50, align: 'center' },
                    { binding: 'clienteUsuario', header: 'Cliente / Usuario', width: 180, align: 'center' },
                    {
                        binding: 'nombreCompleto',
                        header: 'Nombre Completo',
                        minWidth: 220,
                        width: '*',
                        align: 'center',
                        isReadOnly: true
                    },
                    { binding: 'idCliente', header: 'Empresa', minWidth: 250, width: '*', align: 'center' },
                    { binding: 'idPuesto', header: 'Puesto', width: 200, align: 'center' },
                    { binding: 'telefono', header: 'Telefono', width: 150, align: 'center' },
                    { binding: 'correo', header: 'Correo', width: 200, align: 'center' },
                    { header: '', isReadOnly: true, width: 80, align: 'center' }
                ],
                isReadOnly: true,
                itemFormatter: function (panel, r, c, cell) {
                    if (panel.cellType === wijmo.grid.CellType.Cell) {
                        const rowData = panel.rows[r].dataItem; // Obtiene los datos de la fila.
                        const flgActivo = rowData.flgActivo; // Verificar el valor de FlgActivo.

                        // Combinar nombre, apellido paterno y apellido materno en la columna "Nombre Completo"
                        if (panel.columns[c].binding === 'nombreCompleto') {
                            const nombreCompleto = `${rowData.nombreClienteUsuario} ${rowData.apellidoPaternoClienteUsuario} ${rowData.apellidoMaternoClienteUsuario}`;
                            cell.textContent = nombreCompleto;
                        }

                        // Enlace para teléfono
                        if (panel.columns[c].binding === 'telefono' && rowData.telefono) {
                            cell.innerHTML = `<a href="tel:${rowData.telefono}" class="enlace-telefono" style="text-decoration: none; color: inherit;">${rowData.telefono}</a>`;
                        }

                        // Enlace para correo
                        if (panel.columns[c].binding === 'correo' && rowData.correo) {
                            cell.innerHTML = `<a href="mailto:${rowData.correo}" class="enlace-correo" style="text-decoration: none; color: inherit;">${rowData.correo}</a>`;
                        }

                        // Mostrar la razón social en lugar del idCliente
                        if (panel.columns[c].binding === 'idCliente') {
                            cell.textContent = rowData.razonSocial; // Muestra la razón social en lugar del idCliente.
                        }
                        // Mostrar la razón social en lugar del idPuesto
                        if (panel.columns[c].binding === 'idPuesto') {
                            cell.textContent = rowData.descripcion; // Muestra la razón social en lugar del idCliente.
                        }

                        if (c === 0) {
                            cell.textContent = (r + 1).toString(); // Muestra el número de fila.
                        } else if (c === panel.columns.length - 1) {
                            // Crear los botones según el valor de FlgActivo
                            let botones = '';
                            if (flgActivo === true) {
                                botones = `
                                <div class="d-flex justify-content-center align-items-center gap-2">
                                    <button style="height: 25px; width: 25px;" class="btn btn-phoenix-secondary btn-icon fs--2 text-900 abrirModalEditarClienteUsuario" onclick="EditarClienteUsuario(${rowData.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                            <button style="height: 25px; width: 25px;" class="btn btn-phoenix-secondary btn-icon fs--2 text-danger abrirModalEliminarClienteUsuario" data-id="${rowData.id}" data-nombre="${rowData.clienteUsuario}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>`;
                            } else if (flgActivo === false) {
                                botones = `
                                <div class="d-flex justify-content-center align-items-center gap-2">
                                            <button style="height: 25px; width: 25px;" class="btn btn-phoenix-secondary btn-icon fs--2 text-success abrirModalConfirmarClienteUsuario" data-id="${rowData.id}" data-nombre="${rowData.clienteUsuario}">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </div>`;
                            }

                            // Insertar los botones en la celda
                            cell.innerHTML = botones;
                        }
                    }
                }
            });

            verClientesUsuarios();
            //============================================================================================================================\\
            //==========================================  Funcionalidad de Búsqueda y Autocompletar   =====================================\\
            //==============================================================================================================================\\
            $('#inputBusqueda').autocomplete({
                source: function (request, response) {
                    const term = request.term.toLowerCase(); // Obtiene el término de búsqueda.
                    const clientesusuarios = gridClientesUsuarios.itemsSource; // Obtiene la lista de clientes usuarios.
                    const resultados = clientesusuarios.filter(clienteusuario =>
                        clienteusuario.clienteUsuario.toLowerCase().includes(term) || // Busca por nombre de cliente usuario.
                        clienteusuario.nombreClienteUsuario.toLowerCase().includes(term) || // Busca por nombre.
                        clienteusuario.apellidoPaternoClienteUsuario.toLowerCase().includes(term) || // Busca por apellido paterno.
                        clienteusuario.apellidoMaternoClienteUsuario.toLowerCase().includes(term) ||
                        clienteusuario.descripcion.toLowerCase().includes(term) ||
                        clienteusuario.telefono.toLowerCase().includes(term) || // Busca por teléfono.
                        clienteusuario.correo.toLowerCase().includes(term)
                    ).slice(0, 5);
                    response(resultados.map(clienteusuario => ({
                        label: `${clienteusuario.clienteUsuario} (${clienteusuario.correo})`, // Muestra el nombre de cliente usuario y correo.
                        value: clienteusuario.clienteUsuario // Asigna el ID del cliente usuario como valor.
                    })));
                },
                select: function (event, ui) {
                    const clienteusuarioId = ui.item.value; // Obtiene el ID del cliente usuario seleccionado.
                    const clienteusuario = gridClientesUsuarios.itemsSource.find(u => u.id === clienteusuarioId); // Busca el cliente usuario en la grilla.
                    if (clienteusuario) {
                        gridClientesUsuarios.itemsSource = [clienteusuario]; // Filtra la grilla para mostrar solo el cliente usuario seleccionado.
                    }
                }
            });

            // Evento para buscar al hacer clic en el botón de búsqueda.
            $('#btnBuscar').on('click', function () {
                const term = $('#inputBusqueda').val().toLowerCase(); // Obtiene el término de búsqueda.
                const clientesusuarios = gridClientesUsuarios.itemsSource; // Obtiene la lista de clientes usuarios.
                const resultados = clientesusuarios.filter(clienteusuario =>
                    clienteusuario.clienteUsuario.toLowerCase().includes(term) || // Busca por nombre de cliente usuario.
                    clienteusuario.nombreClienteUsuario.toLowerCase().includes(term) || // Busca por nombre.
                    clienteusuario.apellidoPaternoClienteUsuario.toLowerCase().includes(term) || // Busca por apellido paterno.
                    clienteusuario.apellidoMaternoClienteUsuario.toLowerCase().includes(term) ||
                    clienteusuario.descripcion.toLowerCase().includes(term) ||
                    clienteusuario.telefono.toLowerCase().includes(term) || // Busca por teléfono.
                    clienteusuario.correo.toLowerCase().includes(term)
                ).slice(0, 5);

                if (resultados.length > 0) {
                    gridClientesUsuarios.itemsSource = resultados; // Filtra la grilla para mostrar los resultados.
                    $('#mensajeNoEncontrado').hide(); // Oculta el mensaje de "Puesto no encontrado".
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'No se encontró ningún resultado',
                    });
                }
            });

            // Evento para limpiar la búsqueda y mostrar todos los clientes usuarios.
            $('#inputBusqueda').on('input', function () {
                if ($(this).val() === '') {
                    verClientesUsuarios(); // Recarga todos los clientes usuarios.
                    $('#mensajeNoEncontrado').hide(); // Oculta el mensaje de "Cliente usuario no encontrado".
                }
            });

            //============================================================================================================================\\
            //==========================================      Funcionalidad del botón Recargar       ======================================\\
            //==============================================================================================================================\\

            $('#btnReloadClientesUsuarios').on('click', function () {
                // Ocultar el grid de clientes usuarios
                document.getElementById('GridClientesUsuarios').style.visibility = 'hidden';

                // Bloquear el contenido principal con el estilo "arrows"
                Notiflix.Block.arrows('.card', 'Actualizando datos...', {
                    backgroundColor: 'rgba(255, 255, 255, 0.8)', // Fondo semitransparente
                    svgSize: '50px', // Tamaño del ícono de flechas
                    messageFontSize: '16px', // Tamaño del mensaje
                });

                // Llamar a la función verClientesUsuarios para recargar el grid
                verClientesUsuarios().then((serverResponseTime) => {
                    // Tiempo adicional de 500 ms después de la respuesta del servidor
                    setTimeout(() => {
                        // Desbloquear el contenido principal
                        Notiflix.Block.remove('.card');

                        // Mostrar el grid después de que termine la animación de éxito
                        document.getElementById('GridClientesUsuarios').style.visibility = 'visible';
                    }, serverResponseTime + 500); // Tiempo del servidor + 500 ms
                }).catch(() => {
                    // En caso de error, desbloquear el contenido principal
                    Notiflix.Block.remove('.card');

                    // Mostrar un mensaje de error con SweetAlert2 (puedes cambiarlo por Notiflix si prefieres)
                    Swal.fire({
                        title: 'Error',
                        text: 'Hubo un error al recargar los clientes usuarios.',
                        icon: 'error',
                        timer: 2000,
                        timerProgressBar: true,
                        showConfirmButton: false,
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        allowEnterKey: false
                    });

                    // Mostrar el grid incluso si hay un error
                    document.getElementById('GridClientesUsuarios').style.visibility = 'visible';
                });
            });

            //============================================================================================================================\\
            //========================================== Funcionalidad del boton de Agregar Cliente Usuario  ==============================\\
            //==============================================================================================================================\\
           
            $("#InpTelefono").on("input", function () {
                $(this).val($(this).val().replace(/[^0-9+ ]/g, ""));
            });

            //Combobox Empresa
            getDataEmpresa()
                .then(data => {
                    cbIdEmpresa.itemsSource = data;
                    cbIdEmpresa.selectedValue = -1;
                })
                .catch(error => {
                    console.error(error);
                    swal.fire('Error', 'No se pudieron cargar los datos de las empresas disponibles.', 'error');
                    cbIdEmpresa.isDisabled = true;
                });

            //Combobox Puesto
            getDataPuesto()
                .then(data => {
                    cbIdPuesto.itemsSource = data;
                    cbIdPuesto.selectedValue = -1;
                })
                .catch(error => {
                    console.error(error);
                    swal.fire('Error', 'No se pudieron cargar los datos de los puestos disponibles.', 'error');
                    cbIdPuesto.isDisabled = true;
                });

            // Resto del código de validación del formulario
            $("#FormCrearUsuario").validate({
                rules: {
                    InpClienteUsuario: { required: true, minlength: 2 },
                    InpNombreClienteUsuario: { required: true, minlength: 2 },
                    InpApellidoPaternoClienteUsuario: { required: true, minlength: 2 },
                    InpApellidoMaternoClienteUsuario: { required: true, minlength: 2 },
                    InpTelefono: { required: true, maxlength: 15 },
                    InpCorreo: { required: true, email: true },
                    InpContrasena: { required: true, minlength: 8 },
                    InpRepetirContrasena: { required: true, minlength: 8, equalTo: "#InpContrasena" }
                },
                messages: {
                    InpClienteUsuario: { required: "El nombre de cliente usuario es requerido.", minlength: "Mínimo 2 caracteres." },
                    InpNombreClienteUsuario: { required: "El nombre es requerido.", minlength: "Mínimo 2 caracteres." },
                    InpApellidoPaternoClienteUsuario: { required: "El apellido paterno es requerido.", minlength: "Mínimo 2 caracteres." },
                    InpApellidoMaternoClienteUsuario: { required: "El apellido materno es requerido.", minlength: "Mínimo 2 caracteres." },
                    InpTelefono: { required: "El teléfono es requerido.", maxlength: "El teléfono no puede tener más de 15 caracteres." },
                    InpCorreo: { required: "El correo es requerido.", email: "Por favor, introduce un correo válido." },
                    InpContrasena: { required: "La contraseña es requerida.", minlength: "La contraseña debe tener al menos 8 caracteres." },
                    InpRepetirContrasena: { required: "Por favor repite correctamente la contraseña.", minlength: "La contraseña debe tener al menos 8 caracteres.", equalTo: "Las contraseñas no coinciden." }
                },
                submitHandler: function (form, event) {
                    event.preventDefault();

                    // Validar que se haya seleccionado una empresa
                    if (cbIdEmpresa.selectedValue == null || cbIdEmpresa.selectedValue === -1) {
                        swal.fire('Advertencia', 'Por favor selecciona una empresa', 'warning');
                        return; // Detiene la ejecución si no se ha seleccionado una empresa
                    }

                    // Validar que se haya seleccionado un puesto
                    if (cbIdPuesto.selectedValue == null || cbIdPuesto.selectedValue === -1) {
                        swal.fire('Advertencia', 'Por favor selecciona un puesto', 'warning');
                        return; // Detiene la ejecución si no se ha seleccionado un puesto
                    }

                    // Si todo está correcto, llama a la función para agregar el cliente
                    agregarClienteUsuario();
                },
                errorPlacement: function (error, element) {
                    error.addClass('col-12 mt-2 bg-danger text-white text-center p-2 rounded');
                    error.insertAfter(element);
                },
                errorElement: 'div',
                errorClass: 'alert-validate'
            });

            // Evento para previsualizar una imagen seleccionada
            $('#InpImagenExt').on('change', function (event) {
                const file = event.target.files[0]; // Obtiene el archivo seleccionado.
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        $('#previewImage').attr('src', e.target.result); // Muestra la imagen.
                        $('#fileName').text(file.name); // Muestra el nombre del archivo.
                        $('#fileSize').text((file.size / 1024).toFixed(2) + ' KB'); // Muestra el tamaño del archivo.
                        $('#previewContainer').removeClass('d-none'); // Muestra el contenedor de previsualización.
                    };
                    reader.readAsDataURL(file); // Lee el archivo como URL.
                }
            });

            // Evento para eliminar la previsualización de la imagen
            $('#removePreview').on('click', function () {
                $('#previewImage').attr('src', ''); // Limpia la imagen.
                $('#fileName').text(''); // Limpia el nombre del archivo.
                $('#fileSize').text(''); // Limpia el tamaño del archivo.
                $('#previewContainer').addClass('d-none'); // Oculta el contenedor de previsualización.
                $('#InpImagenExt').val(''); // Limpia el input de archivo.
            });

            // Evento para limpiar el formulario al cerrar el modal
            $('#UserModal').on('hidden.bs.modal', function () {
                $('#FormCrearUsuario')[0].reset(); // Restablece el formulario.
                $('#FormCrearUsuario').validate().resetForm();
                $('#previewImage').attr('src', ''); // Limpia la imagen.
                $('#fileName').text(''); // Limpia el nombre del archivo.
                $('#fileSize').text(''); // Limpia el tamaño del archivo.
                $('#previewContainer').addClass('d-none'); // Oculta el contenedor de previsualización.

                // Restablecer el selectedValue del componente Wijmo cbIdEmpresa a -1
                if (cbIdEmpresa && cbIdEmpresa.selectedValue !== undefined) {
                    cbIdEmpresa.selectedValue = -1;
                }

                // Restablecer el selectedValue del componente Wijmo cbIdPuesto a -1
                if (cbIdPuesto && cbIdPuesto.selectedValue !== undefined) {
                    cbIdPuesto.selectedValue = -1;
                }
            });

            // Función para enviar los datos del formulario mediante AJAX
            function agregarClienteUsuario() {
                var formData = new FormData();
                formData.append('ClienteUsuario', $('#InpClienteUsuario').val()); // Enviar el nombre de cliente usuario.
                formData.append('NombreClienteUsuario', $('#InpNombreClienteUsuario').val());
                formData.append('ApellidoPaternoClienteUsuario', $('#InpApellidoPaternoClienteUsuario').val());
                formData.append('ApellidoMaternoClienteUsuario', $('#InpApellidoMaternoClienteUsuario').val());
                formData.append('IdPuesto', cbIdPuesto.selectedValue);// Enviar el ID del puesto.
                formData.append('Telefono', $('#InpTelefono').val());
                formData.append('Correo', $('#InpCorreo').val());
                formData.append('Contrasena', $('#InpContrasena').val());
                formData.append('IdCliente', cbIdEmpresa.selectedValue);
                formData.append('FotoFile', $('#InpImagenExt')[0].files[0]); // Cambiado a FotoFile para coincidir con el backend.

                $.ajax({
                    type: "POST",
                    url: '@Url.Action("AgregarClienteUsuario", "Catalogos")',
                    data: formData,
                    processData: false,
                    contentType: false,
                    beforeSend: function () {
                        // Aquí no se oculta el grid ni se muestra el bloqueo
                    },
                    success: function (response) {
                        if (response.resultado) {
                            // Ocultar el grid de puestos
                            document.getElementById('GridClientesUsuarios').style.visibility = 'hidden';

                            // Bloquear el contenido principal con el estilo "hourglass"
                            Notiflix.Block.circle('.card', 'Agregando Usuario del Cliente...', {
                                backgroundColor: 'rgba(255, 255, 255, 0.8)', // Fondo semitransparente
                                svgSize: '50px', // Tamaño del ícono de reloj de arena
                                messageFontSize: '16px', // Tamaño del mensaje
                            });

                            // Llamar a la función verPuestos para recargar el grid
                            verClientesUsuarios().then((serverResponseTime) => {
                                // Tiempo adicional de 500 ms después de la respuesta del servidor
                                setTimeout(() => {
                                    // Desbloquear el contenido principal
                                    Notiflix.Block.remove('.card');

                                    // Mostrar el grid después de que termine la animación de éxito
                                    document.getElementById('GridClientesUsuarios').style.visibility = 'visible';
                                }, serverResponseTime + 500); // Tiempo del servidor + 500 ms
                            }).catch(() => {
                                // En caso de error, desbloquear el contenido principal
                                Notiflix.Block.remove('.card');
                                document.getElementById('GridClientesUsuarios').style.visibility = 'visible';
                                // Mostrar un mensaje de error con SweetAlert2
                                Swal.fire({
                                    title: 'Error',
                                    text: 'Hubo un error al recargar los puestos.',
                                    icon: 'error',
                                    timer: 2000,
                                    showConfirmButton: true,
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    allowEnterKey: false
                                });

                                // Mostrar el grid incluso si hay un error
                                document.getElementById('GridClientesUsuarios').style.visibility = 'visible';
                            });
                        } else {
                            // Mostrar un mensaje de error con SweetAlert2 si la respuesta no es exitosa
                            Swal.fire({
                                icon: "error",
                                title: "Error",
                                text: response.mensaje,
                                showConfirmButton: true,
                                allowOutsideClick: false,
                                allowEscapeKey: false,
                                allowEnterKey: false

                            });
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        // Mostrar un mensaje de error con SweetAlert2 en caso de error en la solicitud
                        Swal.fire({
                            icon: "error",
                            title: "Error",
                            text: "Ocurrió un error al agregar el puesto.",
                            showConfirmButton: true,
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            allowEnterKey: false
                        });

                        console.error("Error en la solicitud:", textStatus, errorThrown);
                    },
                    complete: function () {
                        // Desbloquear el contenido principal después de 500 ms adicionales
                        setTimeout(() => {
                            Notiflix.Block.remove('.card');
                        }, 500);
                    }
                });

                const ClienteUsuarioModal = bootstrap.Modal.getInstance(document.getElementById('UserModal'));
                ClienteUsuarioModal.hide();
            }

            //============================================================================================================================\\
            //==========================================   Funcionalidad del botón Editar Cliente Usuario    ==============================\\
            //==============================================================================================================================\\
            
            $('.cerrarModalEditarClienteUsuario').on('click', function () {
                const modalEditarClienteUsuario = bootstrap.Modal.getInstance(document.getElementById('ModalEditarClienteUsuario'));
                modalEditarClienteUsuario.hide();
            });

            $("#InpTelefonoEdit").on("input", function () {
                $(this).val($(this).val().replace(/[^0-9+ ]/g, ""));
            });

            // Validación del formulario
            $("#FormEditarClienteUsuario").validate({
                rules: {
                    InpClienteUsuarioEdit: { required: true, minlength: 2 },
                    InpNombreClienteUsuarioEdit: { required: true, minlength: 2 },
                    InpApellidoPaternoClienteUsuarioEdit: { required: true, minlength: 2 },
                    InpApellidoMaternoClienteUsuarioEdit: { required: true, minlength: 2 },
                    InpTelefonoEdit: { required: true, maxlength: 15 },
                    InpCorreoEdit: { required: true, email: true }, // Validar que sea un correo válido
                    InpContrasenaEdit: { required: true, minlength: 8 }, // Mínimo 8 caracteres
                },
                messages: {
                    InpClienteUsuarioEdit: { required: "El nombre de cliente usuario es requerido.", minlength: "Mínimo 2 caracteres." },
                    InpNombreClienteUsuarioEdit: { required: "El nombre es requerido.", minlength: "Mínimo 2 caracteres." },
                    InpApellidoPaternoClienteUsuarioEdit: { required: "El apellido paterno es requerido.", minlength: "Mínimo 2 caracteres." },
                    InpApellidoMaternoClienteUsuarioEdit: { required: "El apellido materno es requerido.", minlength: "Mínimo 2 caracteres." },
                    InpTelefonoEdit: { required: "El teléfono es requerido.", maxlength: "El teléfono no puede tener más de 15 caracteres." },
                    InpCorreoEdit: { required: "El correo es requerido.", email: "Por favor, introduce un correo válido." }, // Mensaje para correo inválido
                    InpContrasenaEdit: { required: "La contraseña es requerida.", minlength: "La contraseña debe tener al menos 8 caracteres." }, // Mensaje para contraseña corta
                },
                submitHandler: function (form, event) {
                    event.preventDefault();
                    actualizarClienteUsuario(); // Llamar a la función sin pasar IdClienteUsuario
                },
                errorPlacement: function (error, element) {
                    error.addClass('col-12 mt-2 bg-danger text-white text-center p-2 rounded');
                    error.insertAfter(element);
                },
                errorElement: 'div',
                errorClass: 'alert-validate'
            });

            // Selecciona todos los campos del formulario de edición
            const camposEdicion = ['#InpClienteUsuarioEdit', '#InpNombreClienteUsuarioEdit', '#InpApellidoPaternoClienteUsuarioEdit', '#InpApellidoMaternoClienteUsuarioEdit', '#InpTelefonoEdit', '#InpClienteUsuarioImagenEdit', 'cbIdEmpresaEdit', 'cbIdPuestoEdit'];

            // Función para habilitar el botón si algún campo ha cambiado
            function habilitarBotonActualizar() {
                let algunCampoCambiado = false;

                camposEdicion.forEach(function (campo) {
                    if ($(campo).val() !== '') {
                        algunCampoCambiado = true;
                    }
                });

                // Habilita el botón si algún campo ha cambiado
                if (algunCampoCambiado) {
                    $('#btnActualizarClienteUsuario').prop('disabled', false);
                } else {
                    $('#btnActualizarClienteUsuario').prop('disabled', true);
                }
            }

            // Escucha los cambios en los campos del formulario
            $('#FormEditarClienteUsuario').on('input change', function () {
                habilitarBotonActualizar();
            });

            // Escucha el evento de cambio en los selectores #cbIdEmpresaEdit y #cbIdPuestoEdit
            $('#cbIdEmpresaEdit, #cbIdPuestoEdit').on('change', function () {
                habilitarBotonActualizar();
            });

            // Escucha el evento de cambio en el input de la imagen
            $('#InpClienteUsuarioImagenEdit').on('change', function (event) {
                const file = event.target.files[0]; // Obtiene el archivo seleccionado.
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        $('#previewImageEdit').attr('src', e.target.result); // Muestra la imagen.
                        $('#fileNameEdit').text(file.name); // Muestra el nombre del archivo.
                        $('#fileSizeEdit').text((file.size / 1024).toFixed(2) + ' KB'); // Muestra el tamaño del archivo.
                        $('#previewContainerEdit').removeClass('d-none'); // Muestra el contenedor de previsualización.
                    };
                    reader.readAsDataURL(file); // Lee el archivo como URL.
                }
                habilitarBotonActualizar();
            });

            $('#btnActualizarClienteUsuario').on('click', function () {
                const id = $(this).data('id'); // Obtiene el ID del cliente usuario.
                const clienteusuario = $('#InpClienteUsuarioEdit').val(); // Obtiene el nombre de cliente usuario.
                const nombreClienteUsuario = $('#InpNombreClienteUsuarioEdit').val(); // Obtiene el nombre.
                const apellidoPaternoClienteUsuario = $('#InpApellidoPaternoClienteUsuarioEdit').val(); // Obtiene el apellido paterno.
                const apellidoMaternoClienteUsuario = $('#InpApellidoMaternoClienteUsuarioEdit').val(); // Obtiene el apellido materno.
                const telefono = $('#InpTelefonoEdit').val(); // Obtiene el teléfono.
                const correo = $('#InpCorreoEdit').val();
                const imagen = $('#InpClienteUsuarioImagenEdit')[0].files[0]; // Obtiene la imagen seleccionada.
                const imagenExistente = $('#previewImageEdit').attr('src'); // Obtiene la imagen existente en base64.

                const formData = new FormData();
                formData.append('Id', id);
                formData.append('ClienteUsuario', clienteusuario);
                formData.append('NombreClienteUsuario', nombreClienteUsuario);
                formData.append('ApellidoPaternoClienteUsuario', apellidoPaternoClienteUsuario);
                formData.append('ApellidoMaternoClienteUsuario', apellidoMaternoClienteUsuario);
                formData.append('IdPuesto', cbIdPuestoEdit.selectedValue); // Enviar el ID del puesto.
                formData.append('Telefono', telefono);
                formData.append('Correo', correo);
                formData.append('Contrasena', $('#InpContrasenaEdit').val());
                formData.append('IdCliente', cbIdEmpresaEdit.selectedValue);

                // Si no se selecciona una nueva imagen, envía la imagen existente en base64.
                if (!imagen && imagenExistente) {
                    formData.append('FotoBase64', imagenExistente); // Envía la imagen existente en base64.
                } else if (imagen) {
                    formData.append('FotoFile', imagen); // Envía la nueva imagen seleccionada.
                }

                $.ajax({
                    type: "POST",
                    url: '@Url.Action("EditarClienteUsuario", "Catalogos")', // Asegúrate de que esta ruta sea correcta.
                    data: formData,
                    processData: false,
                    contentType: false,
                    beforeSend: function () {
                        // Aquí no se oculta el grid ni se muestra el bloqueo
                    },
                    success: function (response) {
                        if (response.resultado) {
                            // Ocultar el grid de puestos
                            document.getElementById('GridClientesUsuarios').style.visibility = 'hidden';

                            // Bloquear el contenido principal con el estilo "hourglass"
                            Notiflix.Block.hourglass('.card', 'Actualizando Usuario del Cliente...', {
                                backgroundColor: 'rgba(255, 255, 255, 0.8)', // Fondo semitransparente
                                svgSize: '50px', // Tamaño del ícono de reloj de arena
                                messageFontSize: '16px', // Tamaño del mensaje
                            });

                            // Llamar a la función verPuestos para recargar el grid
                            verClientesUsuarios().then((serverResponseTime) => {
                                // Tiempo adicional de 500 ms después de la respuesta del servidor
                                setTimeout(() => {
                                    // Desbloquear el contenido principal
                                    Notiflix.Block.remove('.card');

                                    // Mostrar el grid después de que termine la animación de éxito
                                    document.getElementById('GridClientesUsuarios').style.visibility = 'visible';
                                }, serverResponseTime + 500); // Tiempo del servidor + 500 ms
                            }).catch(() => {
                                // En caso de error, desbloquear el contenido principal
                                Notiflix.Block.remove('.card');
                                document.getElementById('GridClientesUsuarios').style.visibility = 'visible';
                                // Mostrar un mensaje de error con SweetAlert2
                                Swal.fire({
                                    title: 'Error',
                                    text: 'Hubo un error al recargar los puestos.',
                                    icon: 'error',
                                    timer: 2000,
                                    showConfirmButton: true,
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    allowEnterKey: false
                                });

                                // Mostrar el grid incluso si hay un error
                                document.getElementById('GridClientesUsuarios').style.visibility = 'visible';
                            });
                        } else {
                            // Mostrar un mensaje de error con SweetAlert2 si la respuesta no es exitosa
                            Swal.fire({
                                icon: "error",
                                title: "Error",
                                text: response.mensaje,
                                showConfirmButton: true,
                                allowOutsideClick: false,
                                allowEscapeKey: false,
                                allowEnterKey: false

                            });
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        // Mostrar un mensaje de error con SweetAlert2 en caso de error en la solicitud
                        Swal.fire({
                            icon: "error",
                            title: "Error",
                            text: "Ocurrió un error al agregar el puesto.",
                            showConfirmButton: true,
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            allowEnterKey: false
                        });

                        console.error("Error en la solicitud:", textStatus, errorThrown);
                    },
                    complete: function () {
                        // Desbloquear el contenido principal después de 500 ms adicionales
                        setTimeout(() => {
                            Notiflix.Block.remove('.card');
                        }, 500);
                    }
                });

                const modalEditarClienteUsuario = bootstrap.Modal.getInstance(document.getElementById('ModalEditarClienteUsuario'));
                modalEditarClienteUsuario.hide(); // Cierra el modal.
            });

            $('#InpClienteUsuarioImagenEdit').on('change', function (event) {
                const file = event.target.files[0]; // Obtiene el archivo seleccionado.
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        $('#previewImageEdit').attr('src', e.target.result); // Muestra la imagen.
                        $('#fileNameEdit').text(file.name); // Muestra el nombre del archivo.
                        $('#fileSizeEdit').text((file.size / 1024).toFixed(2) + ' KB'); // Muestra el tamaño del archivo.
                        $('#previewContainerEdit').removeClass('d-none'); // Muestra el contenedor de previsualización.
                    };
                    reader.readAsDataURL(file); // Lee el archivo como URL.
                }
            });

            // Evento para limpiar el formulario al cerrar el modal
            $('#ModalEditarClienteUsuario').on('hidden.bs.modal', function () {
                $('#FormEditarClienteUsuario')[0].reset(); // Restablece el formulario.
                $('#FormEditarClienteUsuario').validate().resetForm();
                $('#previewImageEdit').attr('src', ''); // Limpia la imagen.
                $('#fileNameEdit').text(''); // Limpia el nombre del archivo.
                $('#fileSizeEdit').text(''); // Limpia el tamaño del archivo.
                // Restablecer el selectedValue del componente Wijmo cbIdEmpresa a -1
                if (cbIdEmpresaEdit && cbIdEmpresaEdit.selectedValue !== undefined) {
                    cbIdEmpresaEdit.selectedValue = -1;
                }

                // Restablecer el selectedValue del componente Wijmo cbIdPuesto a -1
                if (cbIdPuestoEdit && cbIdPuestoEdit.selectedValue !== undefined) {
                    cbIdPuestoEdit.selectedValue = -1;
                }
            });

            //============================================================================================================================\\
            //==========================================   Funcionalidad del botón Eliminar Cliente Usuario  ==============================\\
            //==============================================================================================================================\\
            // Función para abrir el modal de eliminación de cliente usuario.
            function EliminarClienteUsuario(id, clienteusuario) {
                $(".nombreClienteUsuario").text(clienteusuario); // Muestra el nombre del cliente usuario en el modal.
                $("#BtnEliminarClienteUsuario").data("id", id); // Asigna el ID al botón de eliminar.
                const modalEliminar = new bootstrap.Modal(document.getElementById("ModalEliminarClienteUsuario"));
                modalEliminar.show(); // Muestra el modal.
            }

            // Evento para abrir el modal de eliminación.
            $(document).on("click", ".abrirModalEliminarClienteUsuario", function () {
                let id = $(this).data("id"); // Extrae el ID del cliente usuario usando un atributo data-*.
                let clienteusuario = $(this).data("nombre"); // Obtiene el nombre del cliente usuario.
                EliminarClienteUsuario(id, clienteusuario); // Llama a la función para abrir el modal.
            });

            // Evento para cerrar el modal de eliminación.
            $(".cerrarModalEliminarClienteUsuario").on("click", function () {
                const modalEliminar = bootstrap.Modal.getInstance(document.getElementById("ModalEliminarClienteUsuario"));
                modalEliminar.hide(); // Cierra el modal.
            });

            // Evento para manejar la eliminación del cliente usuario.
            $("#FormEliminarClienteUsuario").on("submit", function (e) {
                e.preventDefault(); // Prevenir el envío del formulario por defecto.

                const id = $("#BtnEliminarClienteUsuario").data("id"); // Obtiene el ID del cliente usuario.
           

                const formData = new FormData();
                formData.append('Id', id);

                $.ajax({
                    type: "POST",
                    url: '@Url.Action("DesactivarClienteUsuario", "Catalogos")', // Asegúrate de que la ruta sea correcta.
                    data: formData,
                    contentType: false, // Importante para FormData
                    processData: false, // Importante para FormData
                    beforeSend: function () {
                        // Aquí no se oculta el grid ni se muestra el bloqueo
                    },
                    success: function (response) {
                        if (response.resultado) {
                            // Ocultar el grid de puestos
                            document.getElementById('GridClientesUsuarios').style.visibility = 'hidden';

                            // Bloquear el contenido principal con el estilo "hourglass"
                            Notiflix.Block.hourglass('.card', 'Eliminando Usuario del Cliente...', {
                                backgroundColor: 'rgba(255, 255, 255, 0.8)', // Fondo semitransparente
                                svgSize: '50px', // Tamaño del ícono de reloj de arena
                                messageFontSize: '16px', // Tamaño del mensaje
                            });

                            // Llamar a la función verPuestos para recargar el grid
                            verClientesUsuarios().then((serverResponseTime) => {
                                // Tiempo adicional de 500 ms después de la respuesta del servidor
                                setTimeout(() => {
                                    // Desbloquear el contenido principal
                                    Notiflix.Block.remove('.card');

                                    // Mostrar el grid después de que termine la animación de éxito
                                    document.getElementById('GridClientesUsuarios').style.visibility = 'visible';
                                }, serverResponseTime + 500); // Tiempo del servidor + 500 ms
                            }).catch(() => {
                                // En caso de error, desbloquear el contenido principal
                                Notiflix.Block.remove('.card');
                                document.getElementById('GridClientesUsuarios').style.visibility = 'visible';
                                // Mostrar un mensaje de error con SweetAlert2
                                Swal.fire({
                                    title: 'Error',
                                    text: 'Hubo un error al recargar los puestos.',
                                    icon: 'error',
                                    timer: 2000,
                                    showConfirmButton: true,
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    allowEnterKey: false
                                });

                                // Mostrar el grid incluso si hay un error
                                document.getElementById('GridClientesUsuarios').style.visibility = 'visible';
                            });
                        } else {
                            // Mostrar un mensaje de error con SweetAlert2 si la respuesta no es exitosa
                            Swal.fire({
                                icon: "error",
                                title: "Error",
                                text: response.mensaje,
                                showConfirmButton: true,
                                allowOutsideClick: false,
                                allowEscapeKey: false,
                                allowEnterKey: false

                            });
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        // Mostrar un mensaje de error con SweetAlert2 en caso de error en la solicitud
                        Swal.fire({
                            icon: "error",
                            title: "Error",
                            text: "Ocurrió un error al agregar el puesto.",
                            showConfirmButton: true,
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            allowEnterKey: false
                        });

                        console.error("Error en la solicitud:", textStatus, errorThrown);
                    },
                    complete: function () {
                        // Desbloquear el contenido principal después de 500 ms adicionales
                        setTimeout(() => {
                            Notiflix.Block.remove('.card');
                        }, 500);
                    }
                });

                // Cierra el modal después de iniciar la solicitud AJAX
                const modalEliminar = bootstrap.Modal.getInstance(document.getElementById('ModalEliminarClienteUsuario'));
                modalEliminar.hide();
            });

            //============================================================================================================================\\
            //==========================================  Funcionalidad del botón Reactivar Cliente Usuario  ==============================\\
            //==============================================================================================================================\\
            // Función para abrir el modal de confirmación de reactivación de cliente usuario.
            function ConfirmarClienteUsuario(id, clienteusuario) {
                $(".nombreConfirmarClienteUsuario").text(clienteusuario); // Muestra el nombre del cliente usuario en el modal.
                $("#BtnConfirmarClienteUsuario").data("id", id); // Asigna el ID del cliente usuario al botón de confirmación.
                const modalConfirmar = new bootstrap.Modal(document.getElementById("ModalConfirmarClienteUsuario"));
                modalConfirmar.show(); // Muestra el modal de confirmación.
            }

            // Evento para abrir el modal de confirmación al hacer clic en un botón específico.
            $(document).on("click", ".abrirModalConfirmarClienteUsuario", function () {
                let id = $(this).data("id"); // Obtiene el ID del cliente usuario desde el atributo data-id.
                let clienteusuario = $(this).data("nombre"); // Obtiene el nombre del cliente usuario desde el atributo data-nombre.
                ConfirmarClienteUsuario(id, clienteusuario); // Llama a la función para abrir el modal de confirmación.
            });

            // Evento para cerrar el modal de confirmación al hacer clic en un botón de cierre.
            $(".cerrarModalConfirmarClienteUsuario").on("click", function () {
                const modalConfirmar = bootstrap.Modal.getInstance(document.getElementById("ModalConfirmarClienteUsuario"));
                modalConfirmar.hide(); // Cierra el modal de confirmación.
            });

            // Evento para manejar el envío del formulario de confirmación de reactivación de cliente usuario.
            $("#FormConfirmarClienteUsuario").on("submit", function (e) {
                e.preventDefault(); // Evita el envío tradicional del formulario.

                const id = $("#BtnConfirmarClienteUsuario").data("id"); // Obtiene el ID del cliente usuario desde el botón de confirmación.
         

                const formData = new FormData();
                formData.append('Id', id); // Agrega el ID del cliente usuario al FormData.

                $.ajax({
                    type: "POST",
                    url: '@Url.Action("ReactivarClienteUsuario", "Catalogos")', // URL de la acción que reactiva al cliente usuario.
                    data: formData,
                    contentType: false, // Importante para FormData.
                    processData: false, // Importante para FormData.
                    beforeSend: function () {
                        // Aquí no se oculta el grid ni se muestra el bloqueo
                    },
                    success: function (response) {
                        if (response.resultado) {
                            // Ocultar el grid de puestos
                            document.getElementById('GridClientesUsuarios').style.visibility = 'hidden';

                            // Bloquear el contenido principal con el estilo "hourglass"
                            Notiflix.Block.hourglass('.card', 'Reactivando Usuario del Cliente...', {
                                backgroundColor: 'rgba(255, 255, 255, 0.8)', // Fondo semitransparente
                                svgSize: '50px', // Tamaño del ícono de reloj de arena
                                messageFontSize: '16px', // Tamaño del mensaje
                            });

                            // Llamar a la función verPuestos para recargar el grid
                            verClientesUsuarios().then((serverResponseTime) => {
                                // Tiempo adicional de 500 ms después de la respuesta del servidor
                                setTimeout(() => {
                                    // Desbloquear el contenido principal
                                    Notiflix.Block.remove('.card');

                                    // Mostrar el grid después de que termine la animación de éxito
                                    document.getElementById('GridClientesUsuarios').style.visibility = 'visible';
                                }, serverResponseTime + 500); // Tiempo del servidor + 500 ms
                            }).catch(() => {
                                // En caso de error, desbloquear el contenido principal
                                Notiflix.Block.remove('.card');
                                document.getElementById('GridClientesUsuarios').style.visibility = 'visible';
                                // Mostrar un mensaje de error con SweetAlert2
                                Swal.fire({
                                    title: 'Error',
                                    text: 'Hubo un error al recargar los puestos.',
                                    icon: 'error',
                                    timer: 2000,
                                    showConfirmButton: true,
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    allowEnterKey: false
                                });

                                // Mostrar el grid incluso si hay un error
                                document.getElementById('GridClientesUsuarios').style.visibility = 'visible';
                            });
                        } else {
                            // Mostrar un mensaje de error con SweetAlert2 si la respuesta no es exitosa
                            Swal.fire({
                                icon: "error",
                                title: "Error",
                                text: response.mensaje,
                                showConfirmButton: true,
                                allowOutsideClick: false,
                                allowEscapeKey: false,
                                allowEnterKey: false

                            });
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        // Mostrar un mensaje de error con SweetAlert2 en caso de error en la solicitud
                        Swal.fire({
                            icon: "error",
                            title: "Error",
                            text: "Ocurrió un error al agregar el puesto.",
                            showConfirmButton: true,
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            allowEnterKey: false
                        });

                        console.error("Error en la solicitud:", textStatus, errorThrown);
                    },
                    complete: function () {
                        // Desbloquear el contenido principal después de 500 ms adicionales
                        setTimeout(() => {
                            Notiflix.Block.remove('.card');
                        }, 500);
                    }
                });

                // Cierra el modal de confirmación después de iniciar la solicitud AJAX.
                const modalConfirmar = bootstrap.Modal.getInstance(document.getElementById('ModalConfirmarClienteUsuario'));
                modalConfirmar.hide();
            });

        });

    </script>
}
